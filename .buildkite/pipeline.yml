# .buildkite/pipeline.yml

# å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿åœ¨å¤šä¸ªæ­¥éª¤ä¸­å¤ç”¨
env:
  IMAGE_REPO: "ghcr.io/${BUILDKITE_ORGANIZATION_SLUG}/${BUILDKITE_PIPELINE_SLUG}"
  CONTAINER_NAME: "buildkite-hello-world-go-service"

steps:
  # ã€ç§»é™¤ã€‘ä¸å†éœ€è¦ç‹¬ç«‹çš„ç™»å½•æ­¥éª¤å’Œ depends_on
  # - label: "ğŸ”‘ Login to GHCR"
  #   ...

  # --- è‡ªåŠ¨åŒ– CI æ­¥éª¤ ---
  - label: "ğŸ“¦ Build and Push Image"
    if: build.pull_request.id == null
    plugins:
      # ã€å›å½’å¹¶ä¿®æ­£ã€‘å°†ç™»å½•é€»è¾‘æ”¾å›æ’ä»¶å†…éƒ¨
      - docker#v5.10.0:
          image: "${IMAGE_REPO}"
          # Docker æ’ä»¶ä¼šåœ¨æ‰§è¡Œæ‰€æœ‰æ“ä½œå‰ï¼Œä½¿ç”¨è¿™é‡Œçš„å‡­è¯è¿›è¡Œç™»å½•
          login:
            username: "${BUILDKITE_ORGANIZATION_SLUG}"
            password-env: BUILDKITE_GHCR_TOKEN
          # æ„å»ºä¸æ¨é€çš„é…ç½®
          tag: "${BUILDKITE_DATE_YYYYMMDD}.${BUILDKITE_BRANCH}.${BUILDKITE_COMMIT::8}"
          push: true
    # å°†ç”Ÿæˆçš„é•œåƒæ ‡ç­¾å­˜ä¸ºå…ƒæ•°æ®ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
    artifact_paths:
      - "buildkite-meta-data/docker-image-tag"

  # --- æ‰‹åŠ¨æ‰¹å‡† CD æ­¥éª¤ ---
  - block: "ğŸš€ Deploy to Production"
    prompt: "è¯·ç¡®è®¤æ˜¯å¦å°†ä»¥ä¸‹é•œåƒéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ"
    fields:
      - text: "Image Tag"
        key: "image-tag-to-deploy"
        default: "$(buildkite-agent artifact download 'buildkite-meta-data/docker-image-tag' --stdout)"

  # --- è‡ªåŠ¨åŒ– CD æ­¥éª¤ ---
  - label: "ğŸš€ Executing Deployment"
    command: |
      set -euo pipefail
      IMAGE_TAG=$(buildkite-agent artifact download 'buildkite-meta-data/docker-image-tag' --stdout)
      
      echo "--- éƒ¨ç½²ä¿¡æ¯ ---"
      echo "é•œåƒä»“åº“: ${IMAGE_REPO}"
      echo "é•œåƒæ ‡ç­¾: ${IMAGE_TAG}"

      echo "--- ç™»å½•åˆ° GHCR ---"
      buildkite-agent secret get BUILDKITE_GHCR_TOKEN | docker login ghcr.io -u "${BUILDKITE_ORGANIZATION_SLUG}" --password-stdin

      echo "--- æ‹‰å–æ–°é•œåƒ ---"
      docker pull "${IMAGE_REPO}:${IMAGE_TAG}"

      echo "--- åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨ ---"
      docker stop "${CONTAINER_NAME}" || true
      docker rm "${CONTAINER_NAME}" || true

      echo "--- å¯åŠ¨æ–°å®¹å™¨ ---"
      docker run -d \
        -p 8080:8080 \
        --name "${CONTAINER_NAME}" \
        --restart always \
        "${IMAGE_REPO}:${IMAGE_TAG}"
      
      echo "âœ… éƒ¨ç½²æˆåŠŸï¼"