# .buildkite/pipeline.yml

env:
  IMAGE_REPO: "ghcr.io/${BUILDKITE_ORGANIZATION_SLUG}/${BUILDKITE_PIPELINE_SLUG}"
  CONTAINER_NAME: "buildkite-hello-world-go-service"

steps:
  # æ­¥éª¤ 1: æ˜¾å¼ç™»å½•
  - label: "ğŸ”‘ Login to GHCR"
    if: build.pull_request.id == null
    command: |
      echo "--- Logging in to GHCR ---"
      buildkite-agent secret get GHCR_TOKEN | docker login ghcr.io -u "${BUILDKITE_ORGANIZATION_SLUG}" --password-stdin

  # æ­¥éª¤ 2: ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨åŸç”Ÿ command æ­¥éª¤è¿›è¡Œæ„å»ºå’Œæ¨é€
  - label: "ğŸ“¦ Build and Push Image"
    if: build.pull_request.id == null
    depends_on: "ğŸ”‘ Login to GHCR"
    command: |
      # å¢åŠ è„šæœ¬çš„å¥å£®æ€§
      set -euo pipefail

      # åŠ¨æ€ç”Ÿæˆé•œåƒæ ‡ç­¾
      IMAGE_TAG="${BUILDKITE_DATE_YYYYMMDD}.${BUILDKITE_BRANCH}.${BUILDKITE_COMMIT::8}"
      FULL_IMAGE_NAME="${IMAGE_REPO}:${IMAGE_TAG}"
      
      echo "--- Building image: ${FULL_IMAGE_NAME} ---"
      # ç›´æ¥è°ƒç”¨ docker build
      docker build -t "${FULL_IMAGE_NAME}" .

      echo "--- Pushing image: ${FULL_IMAGE_NAME} ---"
      # ç›´æ¥è°ƒç”¨ docker push
      docker push "${FULL_IMAGE_NAME}"
      
      # å°†ç”Ÿæˆçš„æ ‡ç­¾å­˜ä¸º meta-dataï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
      buildkite-agent meta-data set "image-tag" "${IMAGE_TAG}"

  # æ­¥éª¤ 3: æ‰‹åŠ¨æ‰¹å‡†
  - block: "ğŸš€ Deploy to Production"
    fields:
      - text: "Image Tag"
        key: "image-tag-to-deploy"
        # ã€ä¿®æ”¹ã€‘ä» meta-data ä¸­è·å–æ ‡ç­¾
        default: "$(buildkite-agent meta-data get 'image-tag')"

  # æ­¥éª¤ 4: æ‰§è¡Œéƒ¨ç½²
  - label: "ğŸš€ Executing Deployment"
    command: |
      set -euo pipefail
      # ã€ä¿®æ”¹ã€‘ä» meta-data ä¸­è·å–æ ‡ç­¾
      IMAGE_TAG=$(buildkite-agent meta-data get "image-tag")
      
      echo "--- Deploying image ${IMAGE_TAG} ---"
      
      buildkite-agent secret get GHCR_TOKEN | docker login ghcr.io -u "${BUILDKITE_ORGANIZATION_SLUG}" --password-stdin

      docker pull "${IMAGE_REPO}:${IMAGE_TAG}"
      docker stop "${CONTAINER_NAME}" || true
      docker rm "${CONTAINER_NAME}" || true
      docker run -d -p 8080:8080 --name "${CONTAINER_NAME}" --restart always "${IMAGE_REPO}:${IMAGE_TAG}"
      
      echo "âœ… Deployment successful!"