# .buildkite/pipeline.yml

# å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿åœ¨å¤šä¸ªæ­¥éª¤ä¸­å¤ç”¨
env:
  IMAGE_REPO: "ghcr.io/${BUILDKITE_ORGANIZATION_SLUG}/${BUILDKITE_PIPELINE_SLUG}"
  CONTAINER_NAME: "buildkite-hello-world-go-service"

steps:
  # --- æ–°å¢ï¼šæ˜¾å¼ç™»å½•æ­¥éª¤ ---
  - label: "ğŸ”‘ Login to GHCR"
    if: build.pull_request.id == null
    # è¿™ä¸ªå‘½ä»¤ä¼šå®‰å…¨åœ°ä» Buildkite Secrets è·å–ä»¤ç‰Œå¹¶ç™»å½• Docker
    command: |
      buildkite-agent secret get BUILDKITE_GHCR_TOKEN | docker login ghcr.io -u "${BUILDKITE_ORGANIZATION_SLUG}" --password-stdin

  # --- è‡ªåŠ¨åŒ– CI æ­¥éª¤ ---
  - label: "ğŸ“¦ Build and Push Image"
    if: build.pull_request.id == null
    # ç¡®ä¿æ­¤æ­¥éª¤åœ¨ç™»å½•æˆåŠŸåè¿è¡Œ
    depends_on: "ğŸ”‘ Login to GHCR"
    plugins:
      - docker#v5.10.0:
          image: "${IMAGE_REPO}"
          tag: "${BUILDKITE_DATE_YYYYMMDD}.${BUILDKITE_BRANCH}.${BUILDKITE_COMMIT::8}"
          push: true
          # login å—ç°åœ¨æ˜¯å¯é€‰çš„ï¼Œå› ä¸ºæˆ‘ä»¬å·²åœ¨å‰é¢æ­¥éª¤ç™»å½•ï¼Œä½†ä¿ç•™ä¹Ÿæ— å®³
          login:
            username: "${BUILDKITE_ORGANIZATION_SLUG}"
            password-env: BUILDKITE_GHCR_TOKEN
    # ä¿®æ­£ï¼šæ­£ç¡®åœ°ä¸Šä¼ æ’ä»¶ç”Ÿæˆçš„å…ƒæ•°æ®æ–‡ä»¶
    artifact_paths:
      - "buildkite-meta-data/docker-image-tag"

  # --- æ‰‹åŠ¨æ‰¹å‡† CD æ­¥éª¤ ---
  - block: "ğŸš€ Deploy to Production"
    prompt: "è¯·ç¡®è®¤æ˜¯å¦å°†ä»¥ä¸‹é•œåƒéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ"
    fields:
      - text: "Image Tag"
        key: "image-tag-to-deploy"
        # ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶è·¯å¾„ä¸‹è½½ artifact
        default: "$(buildkite-agent artifact download 'buildkite-meta-data/docker-image-tag' --stdout)"

  # --- è‡ªåŠ¨åŒ– CD æ­¥éª¤ ---
  - label: "ğŸš€ Executing Deployment"
    command: |
      set -euo pipefail

      # ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶è·¯å¾„ä¸‹è½½ artifact
      IMAGE_TAG=$(buildkite-agent artifact download 'buildkite-meta-data/docker-image-tag' --stdout)
      
      echo "--- éƒ¨ç½²ä¿¡æ¯ ---"
      echo "é•œåƒä»“åº“: ${IMAGE_REPO}"
      echo "é•œåƒæ ‡ç­¾: ${IMAGE_TAG}"
      echo "å®¹å™¨åç§°: ${CONTAINER_NAME}"

      # æ³¨æ„ï¼šéƒ¨ç½²æ­¥éª¤ä¹Ÿéœ€è¦ç™»å½•ï¼Œä»¥é˜²åœ¨ä¸åŒçš„ Agent ä¸Šè¿è¡Œ
      echo "--- ç™»å½•åˆ° GHCR ---"
      buildkite-agent secret get BUILDKITE_GHCR_TOKEN | docker login ghcr.io -u "${BUILDKITE_ORGANIZATION_SLUG}" --password-stdin

      echo "--- æ‹‰å–æ–°é•œåƒ ---"
      docker pull "${IMAGE_REPO}:${IMAGE_TAG}"

      echo "--- åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨ ---"
      docker stop "${CONTAINER_NAME}" || true
      docker rm "${CONTAINER_NAME}" || true

      echo "--- å¯åŠ¨æ–°å®¹å™¨ ---"
      docker run -d \
        -p 8080:8080 \
        --name "${CONTAINER_NAME}" \
        --restart always \
        "${IMAGE_REPO}:${IMAGE_TAG}"
      
      echo "âœ… éƒ¨ç½²æˆåŠŸï¼"