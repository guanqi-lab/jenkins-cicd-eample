# .buildkite/pipeline.yml

env:
  IMAGE_REPO: "ghcr.io/${BUILDKITE_ORGANIZATION_SLUG}/${BUILDKITE_PIPELINE_SLUG}"
  CONTAINER_NAME: "buildkite-hello-world-go-service"

steps:
  # è¿™ä¸ªå•ä¸€çš„æ­¥éª¤ç°åœ¨å¤„ç†æ•´ä¸ª CI/CD æµç¨‹
  - label: "ğŸ“¦ Build and Deploy"
    if: build.pull_request.id == null
    # ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨ '|' ç¡®ä¿æ‰€æœ‰å‘½ä»¤åœ¨åŒä¸€ä¸ª Shell è¿›ç¨‹ä¸­æ‰§è¡Œ
    command: |
      # set -euo pipefail ä¼šè®©è„šæœ¬åœ¨ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶ç«‹å³é€€å‡º
      set -euo pipefail

      # --- 1. ç™»å½•åˆ° GHCR ---
      echo "--- Logging in to GHCR ---"
      buildkite-agent secret get GHCR_TOKEN | docker login ghcr.io -u "${BUILDKITE_ORGANIZATION_SLUG}" --password-stdin

      # --- 2. ç”Ÿæˆé•œåƒæ ‡ç­¾ ---
      echo "--- Generating Image Tag ---"
      # ç°åœ¨æ‰€æœ‰å˜é‡éƒ½ä¼šè¢«æ­£ç¡®åœ°å®šä¹‰å’Œä¼ é€’
      COMMIT_SHORT_SHA=$(echo "${BUILDKITE_COMMIT}" | cut -c1-8)
      BUILD_DATE=$(date -u +%Y%m%d)
      IMAGE_TAG="${BUILD_DATE}.${BUILDKITE_BRANCH}.${COMMIT_SHORT_SHA}"
      FULL_IMAGE_NAME="${IMAGE_REPO}:${IMAGE_TAG}"
      echo "Full Image Name: ${FULL_IMAGE_NAME}"

      # --- 3. æ„å»ºæœ¬åœ°é•œåƒ ---
      echo "--- Building local image: ${FULL_IMAGE_NAME} ---"
      docker build -t "${FULL_IMAGE_NAME}" .
      
      # --- 4. éƒ¨ç½²æœ¬åœ°é•œåƒ ---
      echo "--- Deploying image ${FULL_IMAGE_NAME} ---"
      docker stop "${CONTAINER_NAME}" || true
      docker rm "${CONTAINER_NAME}" || true
      docker run -d -p 8080:8080 --name "${CONTAINER_NAME}" --restart always "${FULL_IMAGE_NAME}"
      
      echo "âœ… Build and Deployment successful!"