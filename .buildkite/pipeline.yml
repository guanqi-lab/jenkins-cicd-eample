# å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿åœ¨å¤šä¸ªæ­¥éª¤ä¸­å¤ç”¨
env:
  IMAGE_REPO: "ghcr.io/${BUILDKITE_ORGANIZATION_SLUG}/${BUILDKITE_PIPELINE_SLUG}"
  CONTAINER_NAME: "buildkite-hello-world-go-service"

steps:
  # --- æ–°å¢ï¼šæ˜¾å¼ç™»å½•æ­¥éª¤ ---
  - label: "ğŸ”‘ Login to GHCR"
    if: build.pull_request.id == null
    # è¿™ä¸ªå‘½ä»¤ä¼šå®‰å…¨åœ°ä» Buildkite Secrets è·å–ä»¤ç‰Œå¹¶ç™»å½• Docker
    command: |
      buildkite-agent secret get BUILDKITE_GHCR_TOKEN | docker login ghcr.io -u "${BUILDKITE_ORGANIZATION_SLUG}" --password-stdin

  # --- è‡ªåŠ¨åŒ– CI æ­¥éª¤ ---
  - label: "ğŸ“¦ Build and Push Image"
    if: build.pull_request.id == null
    # ç¡®ä¿æ­¤æ­¥éª¤åœ¨ç™»å½•æˆåŠŸåè¿è¡Œ
    depends_on: "ğŸ”‘ Login to GHCR"
    plugins:
      - docker#v5.10.0:
          image: "${IMAGE_REPO}"
          tag: "${BUILDKITE_DATE_YYYYMMDD}.${BUILDKITE_BRANCH}.${BUILDKITE_COMMIT::8}"
          push: true
          login:
            username: "${BUILDKITE_ORGANIZATION_SLUG}"
            # ä½¿ç”¨ç¬¦åˆè§„èŒƒçš„å¯†é’¥åç§°
            password-env: BUILDKITE_GHCR_TOKEN
    # å°†ç”Ÿæˆçš„é•œåƒæ ‡ç­¾å­˜ä¸ºå…ƒæ•°æ®ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
    artifact_paths:
      - "buildkite-meta-data/docker-image-tag"

  # --- æ‰‹åŠ¨æ‰¹å‡† CD æ­¥éª¤ ---
  - block: "ğŸš€ Deploy to Production"
    prompt: "è¯·ç¡®è®¤æ˜¯å¦å°†ä»¥ä¸‹é•œåƒéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ"
    # æ˜¾ç¤ºå°†è¦éƒ¨ç½²çš„é•œåƒæ ‡ç­¾ï¼Œå¢åŠ æ“ä½œçš„æ¸…æ™°åº¦
    fields:
      - text: "Image Tag"
        key: "image-tag-to-deploy"
        # ä»ä¸Šä¸€æ­¥çš„å…ƒæ•°æ®ä¸­è¯»å–é•œåƒæ ‡ç­¾ä½œä¸ºé»˜è®¤å€¼
        default: "$(buildkite-agent artifact download 'buildkite-meta-data/docker-image-tag' --stdout)"

  # --- è‡ªåŠ¨åŒ– CD æ­¥éª¤ ---
  - label: "ğŸš€ Executing Deployment"
    # å®šä¹‰éƒ¨ç½²è„šæœ¬
    command: |
      set -euo pipefail

      # ä»å…ƒæ•°æ®ä¸­è¯»å–è¦éƒ¨ç½²çš„é•œåƒæ ‡ç­¾
      IMAGE_TAG=$(buildkite-agent artifact download 'buildkite-meta-data/docker-image-tag' --stdout)
      
      echo "--- éƒ¨ç½²ä¿¡æ¯ ---"
      echo "é•œåƒä»“åº“: ${IMAGE_REPO}"
      echo "é•œåƒæ ‡ç­¾: ${IMAGE_TAG}"
      echo "å®¹å™¨åç§°: ${CONTAINER_NAME}"

      echo "--- ç™»å½•åˆ° GHCR ---"
      # ä½¿ç”¨ç¬¦åˆè§„èŒƒçš„å¯†é’¥åç§°
      buildkite-agent secret get BUILDKITE_GHCR_TOKEN | docker login ghcr.io -u "${BUILDKITE_ORGANIZATION_SLUG}" --password-stdin

      echo "--- æ‹‰å–æ–°é•œåƒ ---"
      docker pull "${IMAGE_REPO}:${IMAGE_TAG}"

      echo "--- åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨ ---"
      docker stop "${CONTAINER_NAME}" || true
      docker rm "${CONTAINER_NAME}" || true

      echo "--- å¯åŠ¨æ–°å®¹å™¨ ---"
      docker run -d \
        -p 8080:8080 \
        --name "${CONTAINER_NAME}" \
        --restart always \
        "${IMAGE_REPO}:${IMAGE_TAG}"
      
      echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
