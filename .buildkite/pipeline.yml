# .buildkite/pipeline.yml

env:
  IMAGE_REPO: "ghcr.io/${BUILDKITE_ORGANIZATION_SLUG}/${BUILDKITE_PIPELINE_SLUG}"
  CONTAINER_NAME: "buildkite-hello-world-go-service"

steps:
  # --- æ–°å¢çš„è°ƒè¯•æ­¥éª¤ ---
  - label: "ğŸ” Verify GHCR_TOKEN"
    if: build.pull_request.id == null
    command: |
      echo "--- æ­£åœ¨éªŒè¯ GHCR_TOKEN å¯†é’¥ ---"
      # å®‰å…¨åœ°è·å–å¯†é’¥
      TOKEN_VALUE=$(buildkite-agent secret get GHCR_TOKEN)

      # æ£€æŸ¥å¯†é’¥æ˜¯å¦ä¸ºç©º
      if [ -z "$TOKEN_VALUE" ]; then
        echo "ğŸš¨ é”™è¯¯ï¼šGHCR_TOKEN æœªèƒ½è·å–åˆ°ï¼Œå€¼ä¸ºç©ºï¼"
        echo "è¯·æ£€æŸ¥ Buildkite ç»„ç»‡ä¸­çš„ Secret åç§°æ˜¯å¦ä¸º GHCR_TOKENã€‚"
        exit 1
      else
        echo "âœ… æˆåŠŸè·å–åˆ° GHCR_TOKENã€‚"
        # æ‰“å°å¯†é’¥çš„é•¿åº¦ï¼Œè¿™æ˜¯ä¸€ä¸ªå®‰å…¨çš„éªŒè¯æ–¹å¼
        TOKEN_LENGTH=${#TOKEN_VALUE}
        echo "å¯†é’¥é•¿åº¦ä¸º: $TOKEN_LENGTH"
        # æ‰“å°å¯†é’¥çš„æœ€å4ä½å­—ç¬¦ï¼Œè¿›ä¸€æ­¥ç¡®è®¤
        LAST_FOUR_CHARS=$(echo "$TOKEN_VALUE" | tail -c 5)
        echo "å¯†é’¥çš„æœ€å4ä½å­—ç¬¦ä¸º: ...$LAST_FOUR_CHARS"
        echo "è¯·å°†æ­¤ä¸æ‚¨åœ¨ GitHub ç”Ÿæˆçš„ PAT è¿›è¡Œæ ¸å¯¹ã€‚"
      fi

  # æ­¥éª¤ 2: æ˜¾å¼ç™»å½•
  - label: "ğŸ”‘ Login to GHCR"
    if: build.pull_request.id == null
    # ç¡®ä¿æ­¤æ­¥éª¤åœ¨éªŒè¯æˆåŠŸåæ‰è¿è¡Œ
    depends_on: "ğŸ” Verify GHCR_TOKEN"
    command: |
      echo "--- Logging in to GHCR ---"
      buildkite-agent secret get GHCR_TOKEN | docker login ghcr.io -u "${BUILDKITE_ORGANIZATION_SLUG}" --password-stdin

  # æ­¥éª¤ 3: æ„å»ºå’Œæ¨é€é•œåƒ
  - label: "ğŸ“¦ Build and Push Image"
    if: build.pull_request.id == null
    depends_on: "ğŸ”‘ Login to GHCR"
    plugins:
      - docker#v5.10.0:
          image: "${IMAGE_REPO}"
          tag: "${BUILDKITE_DATE_YYYYMMDD}.${BUILDKITE_BRANCH}.${BUILDKITE_COMMIT::8}"
          push: true
    artifact_paths:
      - "buildkite-meta-data/docker-image-tag"

  # ... åç»­çš„ block å’Œéƒ¨ç½²æ­¥éª¤ä¿æŒä¸å˜ ...

  # --- æ‰‹åŠ¨æ‰¹å‡† CD æ­¥éª¤ ---
  - block: "ğŸš€ Deploy to Production"
    prompt: "è¯·ç¡®è®¤æ˜¯å¦å°†ä»¥ä¸‹é•œåƒéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ"
    fields:
      - text: "Image Tag"
        key: "image-tag-to-deploy"
        default: "$(buildkite-agent artifact download 'buildkite-meta-data/docker-image-tag' --stdout)"

  # --- è‡ªåŠ¨åŒ– CD æ­¥éª¤ ---
  - label: "ğŸš€ Executing Deployment"
    command: |
      set -euo pipefail
      IMAGE_TAG=$(buildkite-agent artifact download 'buildkite-meta-data/docker-image-tag' --stdout)
      
      echo "--- éƒ¨ç½²ä¿¡æ¯ ---"
      echo "é•œåƒä»“åº“: ${IMAGE_REPO}"
      echo "é•œåƒæ ‡ç­¾: ${IMAGE_TAG}"

      echo "--- ç™»å½•åˆ° GHCR ---"
      buildkite-agent secret get BUILDKITE_GHCR_TOKEN | docker login ghcr.io -u "${BUILDKITE_ORGANIZATION_SLUG}" --password-stdin

      echo "--- æ‹‰å–æ–°é•œåƒ ---"
      docker pull "${IMAGE_REPO}:${IMAGE_TAG}"

      echo "--- åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨ ---"
      docker stop "${CONTAINER_NAME}" || true
      docker rm "${CONTAINER_NAME}" || true

      echo "--- å¯åŠ¨æ–°å®¹å™¨ ---"
      docker run -d \
        -p 8080:8080 \
        --name "${CONTAINER_NAME}" \
        --restart always \
        "${IMAGE_REPO}:${IMAGE_TAG}"
      
      echo "âœ… éƒ¨ç½²æˆåŠŸï¼"