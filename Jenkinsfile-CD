// jenkins/jenkins-cicd/Jenkinsfile-CD

pipeline {
    // ä»£ç†ï¼šåœ¨ Jenkins ä¸»èŠ‚ç‚¹ä¸Šæ‰§è¡Œæ‰€æœ‰æ“ä½œ
    agent any

    // å‚æ•°ï¼šå®šä¹‰æµæ°´çº¿æ¥æ”¶çš„å‚æ•°
    // è¿™ä¸ª IMAGE_TAG å°†ç”± GitHub Actions åœ¨è§¦å‘æ—¶ä¼ å…¥
    parameters {
        string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'è¦éƒ¨ç½²çš„ Docker é•œåƒæ ‡ç­¾')
        // ã€æ–°å¢ã€‘å®šä¹‰ç”¨äºæ¥æ”¶ Commit ä¿¡æ¯çš„å‚æ•°
        string(name: 'COMMIT_AUTHOR', defaultValue: 'N/A', description: 'ä»£ç æäº¤äºº')
        string(name: 'COMMIT_MESSAGE', defaultValue: 'N/A', description: 'ä»£ç æäº¤ä¿¡æ¯')
        string(name: 'COMMIT_URL', defaultValue: '#', description: 'ä»£ç æäº¤é“¾æ¥')
    }

    // ç¯å¢ƒå˜é‡ï¼šå®šä¹‰æ•´ä¸ªæµæ°´çº¿ä¸­å¯ç”¨çš„å˜é‡ï¼Œæ–¹ä¾¿ç®¡ç†å’Œä¿®æ”¹
    environment {
        // GitHub é•œåƒä»“åº“åœ°å€
        REGISTRY        = 'ghcr.io'
        // æ‚¨çš„ GitHub ç”¨æˆ·åï¼ˆè¯·ä¿®æ”¹ä¸ºæ‚¨çš„ï¼ï¼‰
        GITHUB_USERNAME = 'guanqi-lab' // <--- è¯·ä¿®æ”¹ä¸ºæ‚¨çš„ GitHub ç”¨æˆ·å
        // é•œåƒçš„å®Œæ•´åç§°
        IMAGE_NAME      = "${REGISTRY}/${GITHUB_USERNAME}/jenkins-cicd-eample" // <--- å¦‚æœä»“åº“åä¸åŒï¼Œè¯·ä¿®æ”¹
        // éƒ¨ç½²åå®¹å™¨çš„åç§°ï¼Œæ–¹ä¾¿ç®¡ç†
        CONTAINER_NAME  = 'hello-world-go-service'
    }

    stages {
        // éƒ¨ç½²é˜¶æ®µ
        stage('Deploy Service') {
            steps {
                script {
                    echo "ğŸš€ Starting deployment for image: ${env.IMAGE_NAME}:${params.IMAGE_TAG}"

                    // ä½¿ç”¨ 'withCredentials' å—å®‰å…¨åœ°åŠ è½½å‡­è¯
                    // 'github-ghcr-token' æ˜¯æ‚¨åœ¨ Jenkins ä¸­å­˜å‚¨çš„ GitHub PAT (Secret textç±»å‹)
                    withCredentials([string(credentialsId: 'github-ghcr-token', variable: 'GHCR_TOKEN')]) {
                        
                        // ç™»å½•åˆ° GHCR
                        sh "echo ${GHCR_TOKEN} | docker login ${env.REGISTRY} -u ${env.GITHUB_USERNAME} --password-stdin"

                        echo "âœ… Docker login successful."

                        // --- æ ¸å¿ƒéƒ¨ç½²é€»è¾‘ ---

                        echo "ğŸ›‘ Stopping and removing old container (if it exists)..."
                        // ä½¿ç”¨ '|| true' ç¡®ä¿åœ¨å®¹å™¨ä¸å­˜åœ¨æ—¶ï¼Œå‘½ä»¤ä¸ä¼šå¤±è´¥å¹¶ä¸­æ­¢æµæ°´çº¿
                        sh "docker stop ${env.CONTAINER_NAME} || true"
                        sh "docker rm ${env.CONTAINER_NAME} || true"

                        echo "ğŸšš Pulling new Docker image..."
                        sh "docker pull ${env.IMAGE_NAME}:${params.IMAGE_TAG}"

                        echo "âœ¨ Starting new container..."
                        sh """
                        docker run -d \
                          -p 28080:28080 \
                          --name ${env.CONTAINER_NAME} \
                          --restart always \
                          ${env.IMAGE_NAME}:${params.IMAGE_TAG}
                        """
                        
                        echo "ğŸ‰ Deployment successful!"
                    }
                }
            }
        }
    }

    post {
        // ä½¿ç”¨ always å—ç¡®ä¿æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½ä¼šå°è¯•å‘é€é‚®ä»¶
        always {
            script {
                // åˆ¤æ–­å½“å‰æ„å»ºçŠ¶æ€
                def currentStatus = currentBuild.result ?: 'SUCCESS'
                def subject, body

                if (currentStatus == 'SUCCESS') {
                    subject = "âœ… DEPLOY SUCCESS: Image [${params.IMAGE_TAG}] Deployed"
                    body = """
                    <p><b>éƒ¨ç½²æˆåŠŸé€šçŸ¥</b></p>
                    <p>ä¸€ä¸ªæ–°çš„é•œåƒå·²æˆåŠŸéƒ¨ç½²ã€‚</p>
                    <ul>
                        <li><b>ä½œä¸šåç§°:</b> ${env.JOB_NAME}</li>
                        <li><b>é•œåƒæ ‡ç­¾:</b> ${params.IMAGE_TAG}</li>
                        <li><b>åº”ç”¨è®¿é—®åœ°å€:</b> <a href="${env.APP_URL}">${env.APP_URL}</a></li>
                        <hr>
                        <li><b>è§¦å‘æ¥æº (æäº¤äºº):</b> ${params.COMMIT_AUTHOR}</li>
                        <li><b>æäº¤ä¿¡æ¯:</b> ${params.COMMIT_MESSAGE}</li>
                        <li><b>ç›¸å…³ Commit:</b> <a href="${params.COMMIT_URL}">ç‚¹å‡»æŸ¥çœ‹</a></li>
                        <hr>
                        <li><b>Jenkins æ„å»ºæ—¥å¿—:</b> <a href="${env.BUILD_URL}">ç‚¹å‡»æŸ¥çœ‹</a></li>
                    </ul>
                    """
                } else {
                    subject = "âŒ DEPLOY FAILED: Job [${env.JOB_NAME}]"
                    body = """
                    <p><b>éƒ¨ç½²å¤±è´¥é€šçŸ¥</b></p>
                    <p>åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç«‹å³æ£€æŸ¥ã€‚</p>
                    <ul>
                        <li><b>ä½œä¸šåç§°:</b> ${env.JOB_NAME}</li>
                        <li><b>å°è¯•éƒ¨ç½²çš„é•œåƒ:</b> ${params.IMAGE_TAG}</li>
                        <hr>
                        <li><b>è§¦å‘æ¥æº (æäº¤äºº):</b> ${params.COMMIT_AUTHOR}</li>
                        <li><b>æäº¤ä¿¡æ¯:</b> ${params.COMMIT_MESSAGE}</li>
                        <li><b>ç›¸å…³ Commit:</b> <a href="${params.COMMIT_URL}">ç‚¹å‡»æŸ¥çœ‹</a></li>
                        <hr>
                        <li><b>Jenkins æ„å»ºæ—¥å¿—:</b> <a href="${env.BUILD_URL}">ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†é”™è¯¯</a></li>
                    </ul>
                    """
                }

                // --- æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡Œç›´æ¥æä¾›æ‰€æœ‰é‚®ä»¶é…ç½® ---
                emailext(
                    to: 'q42722180@gmail.com',
                    subject: subject,
                    body: body,
                    mimeType: 'text/html',
                    // æ˜¾å¼æŒ‡å®š SMTP é…ç½®ï¼Œç»•è¿‡å…¨å±€è®¾ç½®
                    smtpHost: 'smtp.gmail.com',
                    smtpPort: 465,
                    smtpUsername: 'guanqi760@gmail.com', // æ‚¨çš„å‘ä»¶äººé‚®ç®±
                    smtpPassword: credentials('gmail-app-password'), // ç›´æ¥é€šè¿‡ ID è°ƒç”¨å‡­è¯
                    useSsl: true // å¼ºåˆ¶ä½¿ç”¨ SSL
                )
            }
        }
    }
}